# ============================================================================
# CI/CD Pipeline - Sistema de Tickets
# ============================================================================
name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'

jobs:
  # ==========================================================================
  # Lint y validaciÃ³n de cÃ³digo
  # ==========================================================================
  lint:
    name: ðŸ” Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check syntax
        run: |
          echo "Checking JavaScript syntax..."
          find src -name "*.js" -exec node --check {} \;
          echo "âœ… All files passed syntax check"

  # ==========================================================================
  # Build y test con PostgreSQL
  # ==========================================================================
  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: tickets_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U test_user; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Run application test
        env:
          NODE_ENV: test
          PORT: 3000
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: test_user
          PGPASSWORD: test_password
          PGDATABASE: tickets_test
          SESSION_SECRET: test-secret-key-minimum-32-characters-long
          ADMIN_USER: admin
          ADMIN_PASSWORD: testadmin123
        run: |
          # Start server in background
          node src/server.js &
          SERVER_PID=$!
          
          # Wait for server to start
          echo "Waiting for server to start..."
          sleep 5
          
          # Test health endpoint
          echo "Testing health endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed (HTTP $HTTP_CODE)"
          else
            echo "âŒ Health check failed (HTTP $HTTP_CODE)"
            kill $SERVER_PID 2>/dev/null
            exit 1
          fi
          
          # Test health/ready endpoint
          echo "Testing health/ready endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health/ready)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Database connection check passed (HTTP $HTTP_CODE)"
          else
            echo "âŒ Database connection check failed (HTTP $HTTP_CODE)"
            kill $SERVER_PID 2>/dev/null
            exit 1
          fi
          
          # Test main page
          echo "Testing main page..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Main page check passed (HTTP $HTTP_CODE)"
          else
            echo "âŒ Main page check failed (HTTP $HTTP_CODE)"
            kill $SERVER_PID 2>/dev/null
            exit 1
          fi
          
          # Cleanup
          kill $SERVER_PID 2>/dev/null
          echo "âœ… All tests passed!"

  # ==========================================================================
  # Security check
  # ==========================================================================
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=high || true
        continue-on-error: true

  # ==========================================================================
  # Deploy a Render (solo en main)
  # ==========================================================================
  deploy:
    name: ðŸš€ Deploy to Render
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Trigger Render Deploy
        run: |
          echo "ðŸš€ Render auto-deploys from main branch"
          echo "Deploy will be triggered automatically by Render"
          echo "Check status at: https://dashboard.render.com"

  # ==========================================================================
  # NotificaciÃ³n de estado
  # ==========================================================================
  notify:
    name: ðŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "Pipeline completed"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"
