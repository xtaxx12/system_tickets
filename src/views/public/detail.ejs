<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title><%= title %></title>
	<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
	<header class="bg-slate-900 text-white">
		<div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
			<h1 class="text-lg font-semibold">Ticket <%= ticket.reference %></h1>
			<nav class="space-x-4 text-sm">
				<a class="text-sky-200 hover:text-white" href="/">Nuevo Ticket</a>
				<a class="text-sky-200 hover:text-white" href="/tickets">Listado</a>
				<a class="text-sky-200 hover:text-white" href="/admin/login">Admin</a>
			</nav>
		</div>
	</header>
	<main class="max-w-3xl mx-auto px-4 py-8">
		<section class="bg-white shadow rounded-lg p-6 space-y-3">
			<p><span class="font-semibold">Solicitante:</span> <%= ticket.requester_name %></p>
			<p><span class="font-semibold">Departamento:</span> <%= ticket.department %></p>
			<p><span class="font-semibold">Tipo de Soporte:</span> <%= ticket.support_type %></p>
			<p><span class="font-semibold">Prioridad:</span> <%= ticket.priority %></p>
			<p><span class="font-semibold">Estado:</span> <%= ticket.status %></p>
			<p><span class="font-semibold">Asunto:</span> <%= ticket.subject %></p>
			<div>
				<p class="font-semibold mb-1">Descripción:</p>
				<p class="whitespace-pre-line"><%= ticket.description %></p>
			</div>
			<% if (ticket.image_path) { %>
				<div>
					<p class="font-semibold mb-1">Imagen adjunta:</p>
					<img class="rounded-md max-w-full" src="<%= ticket.image_path %>" alt="Adjunto" />
				</div>
			<% } %>
			<p><span class="font-semibold">AnyDesk instalado:</span> <%= ticket.has_anydesk ? 'Sí' : 'No' %></p>
			<% if (ticket.has_anydesk && ticket.anydesk_code) { %>
				<p><span class="font-semibold">Código AnyDesk:</span> <%= ticket.anydesk_code %></p>
			<% } %>
			<p><span class="font-semibold">Creado:</span> <%= new Date(ticket.created_at).toLocaleString() %></p>
			<p>
				<a class="inline-flex items-center gap-2 rounded-md bg-sky-600 px-4 py-2 text-white hover:bg-sky-700" href="/tickets/<%= ticket.reference %>/editar?token=<%= ticket.edit_token %>">Editar este ticket</a>
			</p>
		</section>

		<!-- Sección de Comentarios -->
		<section class="bg-white shadow rounded-lg p-6 mt-6">
			<h2 class="text-xl font-semibold mb-4">Conversación</h2>

			<!-- Lista de Comentarios -->
			<% if (comments && comments.length > 0) { %>
				<div class="space-y-4 mb-6">
					<% comments.forEach(comment => { %>
						<div class="border-l-4 border-slate-300 pl-4 py-2">
							<div class="flex items-baseline justify-between mb-1">
								<p class="font-semibold text-sm"><%= comment.author_name %></p>
								<p class="text-xs text-slate-500"><%= new Date(comment.created_at).toLocaleString() %></p>
							</div>
							<p class="text-slate-700 whitespace-pre-line"><%= comment.content %></p>
						</div>
					<% }) %>
				</div>
			<% } else { %>
				<p class="text-slate-500 text-sm mb-6">No hay comentarios aún. Sé el primero en comentar.</p>
			<% } %>

			<!-- Formulario para Nuevo Comentario -->
			<div class="border-t pt-4">
				<h3 class="font-semibold mb-3">Agregar comentario</h3>
				<form method="POST" action="/tickets/<%= ticket.reference %>/comments" class="space-y-3">
					<div>
						<label class="block text-sm font-medium mb-1">Tu nombre</label>
						<input
							type="text"
							name="author_name"
							required
							maxlength="100"
							class="w-full border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500"
							placeholder="Ej: Juan Pérez"
						/>
					</div>
					<div>
						<label class="block text-sm font-medium mb-1">Tu email (opcional)</label>
						<input
							type="email"
							name="author_email"
							maxlength="100"
							class="w-full border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500"
							placeholder="tu@email.com"
						/>
					</div>
					<div>
						<label class="block text-sm font-medium mb-1">Comentario</label>
						<textarea
							name="content"
							rows="4"
							required
							class="w-full border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500"
							placeholder="Escribe tu comentario aquí..."
						></textarea>
					</div>
					<button type="submit" class="rounded-md bg-sky-600 px-4 py-2 text-white hover:bg-sky-700">
						Enviar comentario
					</button>
				</form>
			</div>
		</section>
	</main>
</body>
</html>
