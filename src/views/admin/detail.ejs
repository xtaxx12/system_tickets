<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title><%= title %></title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<style>
		* { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
		body { background: #F7F8FA; }
		.input-field { 
			transition: all 0.2s ease;
			border: 1.5px solid #E2E8F0;
		}
		.input-field:hover { 
			border-color: #CBD5E1;
		}
		.input-field:focus { 
			outline: none;
			border-color: #3B82F6;
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
		}
		.select-field {
			appearance: none;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
			background-position: right 0.75rem center;
			background-repeat: no-repeat;
			background-size: 1.25em 1.25em;
			padding-right: 2.5rem;
		}
		.btn-primary {
			background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
			transition: all 0.2s ease;
		}
		.btn-primary:hover {
			transform: translateY(-1px);
			box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.3);
		}
		.btn-logout {
			background: #FFFFFF;
			border: 1.5px solid #E2E8F0;
			color: #64748B;
			transition: all 0.2s ease;
		}
		.btn-logout:hover {
			background: #F8FAFC;
			border-color: #CBD5E1;
			color: #1E293B;
		}
		.badge {
			display: inline-flex;
			align-items: center;
			padding: 0.375rem 0.75rem;
			border-radius: 9999px;
			font-size: 0.75rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.025em;
		}
		.badge-pendiente { background: #FEF3C7; color: #92400E; }
		.badge-proceso { background: #DBEAFE; color: #1E40AF; }
		.badge-resuelto { background: #D1FAE5; color: #065F46; }
		.badge-cerrado { background: #F3F4F6; color: #374151; }
		.priority-badge {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.375rem 0.875rem;
			border-radius: 9999px;
			font-size: 0.8125rem;
			font-weight: 600;
		}
		.priority-baja { background: #D1FAE5; color: #065F46; }
		.priority-media { background: #FEF3C7; color: #92400E; }
		.priority-alta { background: #FEE2E2; color: #991B1B; }
		.priority-critica { background: #FEE2E2; color: #991B1B; animation: pulse-border 2s infinite; }
		@keyframes pulse-border {
			0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
			50% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); }
		}
		.comment-card {
			transition: all 0.2s ease;
		}
		.comment-card:hover {
			transform: translateX(4px);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
		}
		.comment-internal {
			background: #FFFBEB;
			border-left: 4px solid #F59E0B;
		}
		.comment-public {
			background: #F9FAFB;
			border-left: 4px solid #A78BFA;
		}
		.info-row {
			display: flex;
			padding: 1rem 0;
			border-bottom: 1px solid #F3F4F6;
		}
		.info-row:last-child {
			border-bottom: none;
		}
		.info-label {
			min-width: 160px;
			font-weight: 600;
			color: #6B7280;
			font-size: 0.875rem;
		}
		.info-value {
			color: #1F2937;
			font-size: 0.9375rem;
		}
		.admin-badge {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.5rem 1rem;
			background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
			border: 1px solid #BFDBFE;
			border-radius: 9999px;
			color: #1E40AF;
			font-size: 0.875rem;
			font-weight: 600;
		}
		.status-selector {
			background: #F9FAFB;
			border: 1px solid #E5E7EB;
			border-radius: 12px;
			padding: 1.5rem;
		}
		.notification-btn {
			position: relative;
			padding: 0.5rem;
			background: #F9FAFB;
			border: 1.5px solid #E5E7EB;
			border-radius: 0.5rem;
			color: #6B7280;
			transition: all 0.2s ease;
		}
		.notification-btn:hover {
			background: #F3F4F6;
			border-color: #D1D5DB;
			color: #374151;
		}
		.notification-badge {
			position: absolute;
			top: -4px;
			right: -4px;
			background: #EF4444;
			color: white;
			font-size: 0.625rem;
			font-weight: 700;
			padding: 0.125rem 0.375rem;
			border-radius: 9999px;
			min-width: 1.25rem;
			text-align: center;
		}
		.notification-dropdown {
			display: none;
			position: absolute;
			top: 100%;
			right: 0;
			margin-top: 0.5rem;
			width: 384px;
			max-height: 480px;
			overflow-y: auto;
			background: white;
			border: 1px solid #E5E7EB;
			border-radius: 0.75rem;
			box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
			z-index: 100;
		}
		.notification-dropdown.show {
			display: block;
		}
		.notification-item {
			padding: 1rem;
			border-bottom: 1px solid #F3F4F6;
			transition: all 0.2s ease;
			cursor: pointer;
		}
		.notification-item:hover {
			background: #F9FAFB;
		}
		.notification-item:last-child {
			border-bottom: none;
		}
	</style>
</head>
<body>
	<!-- Header Administrativo -->
	<header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex items-center justify-between h-16">
				<div class="flex items-center gap-4">
					<a href="/admin" class="flex items-center gap-3 hover:opacity-80 transition">
						<svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
						</svg>
						<div>
							<h1 class="text-xl font-semibold text-gray-900">Ticket <%= ticket.reference %></h1>
							<p class="text-xs text-gray-500">Vista de administrador</p>
						</div>
					</a>
				</div>
				<div class="flex items-center gap-3">
					<a href="/admin" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 rounded-lg transition">
						‚Üê Volver al Panel
					</a>
					<!-- Notificaciones -->
					<div class="relative" id="notification-container">
						<button class="notification-btn" id="notification-btn">
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
							</svg>
							<span class="notification-badge" id="notification-badge" style="display: none;">0</span>
						</button>
						<div class="notification-dropdown" id="notification-dropdown">
							<div class="p-4 border-b border-gray-200 flex items-center justify-between">
								<h3 class="font-semibold text-gray-900">Notificaciones</h3>
								<button id="mark-all-read" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
									Marcar todas como le√≠das
								</button>
							</div>
							<div id="notification-list">
								<div class="p-4 text-center text-gray-500 text-sm">
									Cargando notificaciones...
								</div>
							</div>
						</div>
					</div>
					<a href="/admin/perfil" class="admin-badge hover:shadow-md transition">
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
						</svg>
						<span><%= user.username %></span>
					</a>
					<form action="/admin/logout" method="post" class="inline">
						<button type="submit" class="btn-logout px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2">
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
							</svg>
							Salir
						</button>
					</form>
				</div>
			</div>
		</div>
	</header>

	<!-- Main Content -->
	<main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
			<!-- Columna Principal -->
			<div class="lg:col-span-2 space-y-6">
				<!-- Card de Informaci√≥n Principal -->
				<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
					<!-- Header del Ticket -->
					<div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-5 border-b border-gray-200">
						<div class="flex items-start justify-between">
							<div class="flex-1">
								<h2 class="text-xl font-bold text-gray-900 mb-2"><%= ticket.subject %></h2>
								<div class="flex items-center gap-3 flex-wrap">
									<% 
										let statusClass = 'badge-pendiente';
										if (ticket.status === 'En Proceso') statusClass = 'badge-proceso';
										if (ticket.status === 'Resuelto') statusClass = 'badge-resuelto';
										if (ticket.status === 'Cerrado') statusClass = 'badge-cerrado';
										
										let priorityClass = 'priority-baja';
										let priorityLabel = 'Baja';
										if (ticket.priority.includes('Media')) {
											priorityClass = 'priority-media';
											priorityLabel = 'Media';
										}
										if (ticket.priority.includes('Alta') && !ticket.priority.includes('Cr√≠tica')) {
											priorityClass = 'priority-alta';
											priorityLabel = 'Alta';
										}
										if (ticket.priority.includes('Cr√≠tica')) {
											priorityClass = 'priority-critica';
											priorityLabel = 'Cr√≠tica';
										}
									%>
									<span class="badge <%= statusClass %>"><%= ticket.status %></span>
									<span class="priority-badge <%= priorityClass %>">
										<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
											<path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"></path>
										</svg>
										<%= priorityLabel %>
									</span>
								</div>
							</div>
						</div>
					</div>

					<!-- Descripci√≥n -->
					<div class="px-6 py-5 border-b border-gray-100">
						<h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3 flex items-center gap-2">
							<svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
							</svg>
							Descripci√≥n del Problema
						</h3>
						<p class="text-gray-700 whitespace-pre-line leading-relaxed"><%= ticket.description %></p>
					</div>

					<!-- Imagen Adjunta -->
					<% if (ticket.image_path) { %>
						<div class="px-6 py-5 border-b border-gray-100">
							<h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3 flex items-center gap-2">
								<svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
								</svg>
								Imagen Adjunta
							</h3>
							<div class="rounded-lg overflow-hidden border border-gray-200">
								<img class="w-full h-auto" src="<%= ticket.image_path %>" alt="Imagen adjunta del ticket" />
							</div>
						</div>
					<% } %>

					<!-- Detalles Adicionales -->
					<div class="px-6 py-5">
						<h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-4 flex items-center gap-2">
							<svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
							</svg>
							Informaci√≥n Adicional
						</h3>
						<div class="space-y-0">
							<div class="info-row">
								<span class="info-label">Tipo de Soporte</span>
								<span class="info-value flex items-center gap-2">
									<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
									</svg>
									<%= ticket.support_type %>
								</span>
							</div>
							<div class="info-row">
								<span class="info-label">AnyDesk Instalado</span>
								<span class="info-value">
									<% if (ticket.has_anydesk) { %>
										<span class="inline-flex items-center gap-1.5 text-green-700">
											<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
												<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
											</svg>
											S√≠
										</span>
									<% } else { %>
										<span class="inline-flex items-center gap-1.5 text-gray-500">
											<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
												<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
											</svg>
											No
										</span>
									<% } %>
								</span>
							</div>
							<% if (ticket.has_anydesk && ticket.anydesk_code) { %>
								<div class="info-row">
									<span class="info-label">C√≥digo AnyDesk</span>
									<span class="info-value font-mono text-blue-600 font-semibold"><%= ticket.anydesk_code %></span>
								</div>
							<% } %>
							<div class="info-row">
								<span class="info-label">Fecha de Creaci√≥n</span>
								<span class="info-value flex items-center gap-2">
									<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
									</svg>
									<%= new Date(ticket.created_at).toLocaleDateString('es-ES', { 
										weekday: 'long',
										year: 'numeric', 
										month: 'long', 
										day: 'numeric',
										hour: '2-digit',
										minute: '2-digit'
									}) %>
								</span>
							</div>
						</div>
					</div>
				</div>

				<!-- Secci√≥n de Conversaci√≥n -->
				<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
					<div class="bg-gradient-to-r from-purple-50 to-pink-50 px-6 py-5 border-b border-gray-200">
						<div class="flex items-center justify-between">
							<div class="flex items-center gap-3">
								<svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
								</svg>
								<div>
									<h2 class="text-xl font-bold text-gray-900">Conversaci√≥n</h2>
									<p class="text-sm text-gray-600"><%= comments && comments.length > 0 ? comments.length : 'Sin' %> comentario<%= comments && comments.length !== 1 ? 's' : '' %></p>
								</div>
							</div>
						</div>
					</div>

					<div class="px-6 py-6">
						<!-- Lista de Comentarios -->
						<% if (comments && comments.length > 0) { %>
							<div class="space-y-4 mb-8">
								<% comments.forEach((comment, index) => { %>
									<div class="comment-card <%= comment.is_internal ? 'comment-internal' : 'comment-public' %> rounded-xl p-5">
										<div class="flex items-start gap-4">
											<div class="flex-shrink-0">
												<div class="w-10 h-10 bg-gradient-to-br <%= comment.is_internal ? 'from-amber-400 to-orange-500' : 'from-purple-400 to-pink-500' %> rounded-full flex items-center justify-center text-white font-semibold">
													<%= comment.author_name.charAt(0).toUpperCase() %>
												</div>
											</div>
											<div class="flex-1 min-w-0">
												<div class="flex items-baseline justify-between mb-2">
													<div class="flex items-center gap-2">
														<h4 class="text-sm font-semibold text-gray-900"><%= comment.author_name %></h4>
														<% if (comment.is_internal) { %>
															<span class="inline-flex items-center gap-1 px-2 py-0.5 bg-amber-500 text-white text-xs font-bold rounded-full">
																<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
																	<path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
																</svg>
																INTERNO
															</span>
														<% } %>
													</div>
													<time class="text-xs text-gray-500 flex items-center gap-1">
														<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
															<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
														</svg>
														<%= new Date(comment.created_at).toLocaleDateString('es-ES', { 
															month: 'short', 
															day: 'numeric',
															hour: '2-digit',
															minute: '2-digit'
														}) %>
													</time>
												</div>
												<p class="text-gray-700 whitespace-pre-line text-sm leading-relaxed"><%= comment.content %></p>
												<% if (comment.author_email) { %>
													<p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
														<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
															<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
														</svg>
														<%= comment.author_email %>
													</p>
												<% } %>
											</div>
										</div>
									</div>
								<% }) %>
							</div>
						<% } else { %>
							<div class="text-center py-8 mb-8">
								<svg class="mx-auto h-16 w-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
								</svg>
								<p class="mt-3 text-sm text-gray-500">No hay comentarios a√∫n.</p>
							</div>
						<% } %>

						<!-- Formulario para Nuevo Comentario -->
						<div class="border-t border-gray-200 pt-6">
							<h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
								<svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
								</svg>
								Agregar Comentario como <%= user.username %>
							</h3>
							<form method="POST" action="/admin/tickets/<%= ticket.reference %>/comments" class="space-y-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">
										Comentario
										<span class="text-red-500 ml-1">*</span>
									</label>
									<textarea
										name="content"
										rows="4"
										required
										class="input-field w-full px-4 py-3 rounded-lg bg-white text-gray-900 placeholder-gray-400 resize-none"
										placeholder="Escribe tu comentario aqu√≠..."
									></textarea>
								</div>
								<div class="flex items-center gap-3 p-4 bg-amber-50 border border-amber-200 rounded-lg">
									<input
										type="checkbox"
										name="is_internal"
										id="is_internal"
										value="true"
										class="w-5 h-5 text-amber-600 border-gray-300 rounded focus:ring-2 focus:ring-amber-500"
									/>
									<label for="is_internal" class="text-sm flex-1">
										<span class="font-semibold text-gray-900">Marcar como comentario interno</span>
										<span class="block text-gray-600 text-xs mt-0.5">Solo visible para administradores</span>
									</label>
									<svg class="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
										<path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
									</svg>
								</div>
								<div class="flex items-center justify-end">
									<button type="submit" class="btn-primary px-6 py-3 rounded-lg text-white font-semibold shadow-lg flex items-center gap-2">
										<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
										</svg>
										Enviar Comentario
									</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>

			<!-- Sidebar Derecho -->
			<div class="lg:col-span-1 space-y-6">
				<!-- Card de Solicitante -->
				<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
					<div class="bg-gradient-to-r from-green-50 to-emerald-50 px-5 py-4 border-b border-gray-200">
						<h3 class="text-sm font-semibold text-gray-900 uppercase tracking-wide flex items-center gap-2">
							<svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
							</svg>
							Solicitante
						</h3>
					</div>
					<div class="p-5">
						<div class="flex items-center gap-3 mb-4">
							<div class="w-14 h-14 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
								<%= ticket.requester_name.charAt(0).toUpperCase() %>
							</div>
							<div>
								<p class="font-semibold text-gray-900 text-base"><%= ticket.requester_name %></p>
								<p class="text-sm text-gray-600"><%= ticket.department %></p>
							</div>
						</div>
						<% if (ticket.email) { %>
							<div class="mt-4 pt-4 border-t border-gray-100">
								<p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Email</p>
								<a href="mailto:<%= ticket.email %>" class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
									</svg>
									<%= ticket.email %>
								</a>
							</div>
						<% } %>
					</div>
				</div>

				<!-- Card de Gesti√≥n de Estado -->
				<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
					<div class="bg-gradient-to-r from-indigo-50 to-purple-50 px-5 py-4 border-b border-gray-200">
						<h3 class="text-sm font-semibold text-gray-900 uppercase tracking-wide flex items-center gap-2">
							<svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
							</svg>
							Gesti√≥n de Estado
						</h3>
					</div>
					<div class="p-5">
						<form action="/admin/tickets/<%= ticket.reference %>/estado" method="post" class="space-y-4">
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2">
									Cambiar Estado del Ticket
								</label>
								<select name="status" class="input-field select-field w-full px-4 py-3 rounded-lg bg-white text-gray-900">
									<% ['Pendiente','En Proceso','Resuelto','Cerrado'].forEach(s=>{ %>
										<option value="<%= s %>" <%= ticket.status===s ? 'selected' : '' %>><%= s %></option>
									<% }) %>
								</select>
							</div>
							<button type="submit" class="btn-primary w-full py-3 rounded-lg text-white font-semibold shadow-lg flex items-center justify-center gap-2">
								<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
								</svg>
								Actualizar Estado
							</button>
						</form>
						<p class="mt-3 text-xs text-gray-500 text-center">Los cambios se aplicar√°n inmediatamente</p>
					</div>
				</div>

				<!-- Card de Asignaci√≥n de T√©cnico -->
				<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
					<div class="bg-gradient-to-r from-blue-50 to-cyan-50 px-5 py-4 border-b border-gray-200">
						<h3 class="text-sm font-semibold text-gray-900 uppercase tracking-wide flex items-center gap-2">
							<svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
							</svg>
							Asignaci√≥n de T√©cnico
						</h3>
					</div>
					<div class="p-5">
						<% if (ticket.assigned_username) { %>
							<div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
								<p class="text-xs font-medium text-blue-800 mb-1">Actualmente asignado a:</p>
								<div class="flex items-center gap-2">
									<div class="flex-shrink-0 h-8 w-8 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white font-semibold text-sm">
										<%= ticket.assigned_username.charAt(0).toUpperCase() %>
									</div>
									<p class="text-sm font-semibold text-blue-900"><%= ticket.assigned_username %></p>
								</div>
							</div>
						<% } else { %>
							<div class="mb-4 bg-gray-50 border border-gray-200 rounded-lg p-3">
								<p class="text-xs font-medium text-gray-600 text-center">Sin asignar</p>
							</div>
						<% } %>

						<form action="/admin/tickets/<%= ticket.reference %>/asignar" method="post" class="space-y-4">
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2">
									Asignar a T√©cnico
								</label>
								<select name="technician_id" class="input-field select-field w-full px-4 py-3 rounded-lg bg-white text-gray-900" <% if (!['admin', 'supervisor'].includes(user.role)) { %>disabled<% } %>>
									<option value="">-- Sin asignar --</option>
									<% technicians.forEach(tech => {
										let roleLabel = '';
										if (tech.role === 'admin') roleLabel = ' üëë Admin';
										else if (tech.role === 'supervisor') roleLabel = ' üëÅÔ∏è Supervisor';
										else if (tech.role === 'tecnico') roleLabel = ' üîß T√©cnico';
									%>
										<option value="<%= tech.id %>" <%= ticket.assigned_to === tech.id ? 'selected' : '' %>>
											<%= tech.username %><%= roleLabel %>
										</option>
									<% }) %>
								</select>
								<% if (!['admin', 'supervisor'].includes(user.role)) { %>
									<p class="text-xs text-amber-600 mt-2">‚ö†Ô∏è Solo supervisores y administradores pueden asignar tickets</p>
								<% } %>
							</div>
							<button type="submit" class="btn-primary w-full py-3 rounded-lg text-white font-semibold shadow-lg flex items-center justify-center gap-2" <% if (!['admin', 'supervisor'].includes(user.role)) { %>disabled style="opacity: 0.5; cursor: not-allowed;"<% } %>>
								<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
								</svg>
								Asignar T√©cnico
							</button>
						</form>
						<p class="mt-3 text-xs text-gray-500 text-center">Seleccione un t√©cnico para asignar el ticket</p>
					</div>
				</div>

				<!-- Card de Referencia -->
				<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
					<div class="bg-gradient-to-r from-amber-50 to-yellow-50 px-5 py-4 border-b border-gray-200">
						<h3 class="text-sm font-semibold text-gray-900 uppercase tracking-wide flex items-center gap-2">
							<svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
							</svg>
							Referencia
						</h3>
					</div>
					<div class="p-5">
						<div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
							<p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">ID del Ticket</p>
							<p class="text-lg font-mono font-bold text-gray-900"><%= ticket.reference %></p>
						</div>
						<p class="mt-3 text-xs text-gray-500">Use esta referencia para consultas</p>
					</div>
				</div>

				<!-- Card de Acciones R√°pidas -->
				<div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl p-5 border border-blue-200">
					<div class="flex gap-3">
						<svg class="w-6 h-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
						</svg>
						<div>
							<h4 class="text-sm font-semibold text-blue-900 mb-2">Acciones Administrativas</h4>
							<ul class="text-xs text-blue-800 space-y-1.5">
								<li class="flex items-center gap-1.5">
									<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
										<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
									</svg>
									Actualiza el estado seg√∫n el progreso
								</li>
								<li class="flex items-center gap-1.5">
									<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
										<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
									</svg>
									Usa comentarios internos para notas
								</li>
								<li class="flex items-center gap-1.5">
									<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
										<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
									</svg>
									Mant√©n informado al solicitante
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>

	<script>
		// Sistema de notificaciones
		let notificationDropdown = null;
		let notificationBtn = null;
		let notificationBadge = null;
		let notificationList = null;

		document.addEventListener('DOMContentLoaded', function() {
			notificationDropdown = document.getElementById('notification-dropdown');
			notificationBtn = document.getElementById('notification-btn');
			notificationBadge = document.getElementById('notification-badge');
			notificationList = document.getElementById('notification-list');

			notificationBtn.addEventListener('click', function(e) {
				e.stopPropagation();
				notificationDropdown.classList.toggle('show');
				if (notificationDropdown.classList.contains('show')) {
					loadNotifications();
				}
			});

			document.addEventListener('click', function(e) {
				if (!document.getElementById('notification-container').contains(e.target)) {
					notificationDropdown.classList.remove('show');
				}
			});

			document.getElementById('mark-all-read').addEventListener('click', function() {
				markAllAsRead();
			});

			loadNotifications();
			setInterval(loadNotifications, 30000);
		});

		async function loadNotifications() {
			try {
				const response = await fetch('/admin/notifications');
				const data = await response.json();

				if (data.count > 0) {
					notificationBadge.textContent = data.count;
					notificationBadge.style.display = 'block';
				} else {
					notificationBadge.style.display = 'none';
				}

				if (data.notifications.length === 0) {
					notificationList.innerHTML = `
						<div class="p-4 text-center text-gray-500 text-sm">
							<svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
							</svg>
							No tienes notificaciones nuevas
						</div>
					`;
				} else {
					notificationList.innerHTML = data.notifications.map(notif => {
						const date = new Date(notif.created_at);
						const timeAgo = getTimeAgo(date);
						return `
							<div class="notification-item" data-id="${notif.id}" data-ticket="${notif.ticket_reference || ''}">
								<div class="flex items-start gap-3">
									<div class="flex-1">
										<h4 class="text-sm font-semibold text-gray-900 mb-1">${notif.title}</h4>
										<p class="text-sm text-gray-600">${notif.message}</p>
										<p class="text-xs text-gray-400 mt-1">${timeAgo}</p>
									</div>
								</div>
							</div>
						`;
					}).join('');

					document.querySelectorAll('.notification-item').forEach(item => {
						item.addEventListener('click', function() {
							const notifId = this.getAttribute('data-id');
							const ticketRef = this.getAttribute('data-ticket');
							markAsRead(notifId);
							if (ticketRef) {
								window.location.href = `/admin/tickets/${ticketRef}`;
							}
						});
					});
				}
			} catch (err) {
				console.error('Error cargando notificaciones:', err);
			}
		}

		async function markAsRead(notificationId) {
			try {
				await fetch(`/admin/notifications/${notificationId}/read`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' }
				});
				loadNotifications();
			} catch (err) {
				console.error('Error marcando notificaci√≥n:', err);
			}
		}

		async function markAllAsRead() {
			try {
				await fetch('/admin/notifications/read-all', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' }
				});
				loadNotifications();
			} catch (err) {
				console.error('Error marcando todas las notificaciones:', err);
			}
		}

		function getTimeAgo(date) {
			const seconds = Math.floor((new Date() - date) / 1000);
			if (seconds < 60) return 'Hace un momento';
			const minutes = Math.floor(seconds / 60);
			if (minutes < 60) return `Hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
			const hours = Math.floor(minutes / 60);
			if (hours < 24) return `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
			const days = Math.floor(hours / 24);
			if (days < 7) return `Hace ${days} d√≠a${days > 1 ? 's' : ''}`;
			const weeks = Math.floor(days / 7);
			return `Hace ${weeks} semana${weeks > 1 ? 's' : ''}`;
		}
	</script>
</body>
</html>
